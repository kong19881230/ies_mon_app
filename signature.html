<!doctype html>
<html>
<head>
    <title>Sketch Pad</title>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=0;" />
    <link rel="stylesheet" href="css/fb-style.min.css" />
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.4.3.min.css">
  	<link rel="stylesheet" href="css/jquery.mobile.icons-1.4.3.min.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.mobile-1.4.3.min.js"></script>
	<script src="cordova.js"></script>
    <style type="text/css">
	  body {
		margin:0px;
		width:100%;
		height:100%;
		overflow:hidden;
        /* prevent text selection on ui */
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        /* prevent scrolling in windows phone */
        -ms-touch-action: none;
	  }
	  #content {
        overflow:hidden;
		background-color:#ddd;
	  }
	  #canvas{
		cursor:crosshair ;
        background-color:#fff;
	  }
	  .palette-case {
		width:260px;
		margin:auto;
		text-align:center;
	  }
	  .palette-box {
		float:left;
		padding:2px 6px 2px 6px;
	  }
	  .palette {
		border:2px solid #777;
		height:36px;
		width:36px;
	  }
	  .red{
		background-color:#c22;
	  }
	  .center-wrapper{
			text-align: center;
		}
	  .blue{
		background-color:#22c;
	  }
	  .green{
		background-color:#2c2;
	  }
	  .white{
		background-color:#fff;
	  }
	  .black{
		background-color:#000;
		border:2px dashed #fff;
	  }
      #etchHelp {
        display: none;
        position: absolute;
        top: 40px;
        right: 4px;
        width: 160px;
        background-color: #ffa;
        color: #222;
        font-size: 14px;
        line-height: 20px;
        border-radius: 4px;
        padding: 6px;
        box-shadow:  0 0 3px 1px #888;
      }
    </style>
	<script type="text/javascript">
var customers= [
								{ 	"id" : "1",
									"name_cn" : "十六浦",
									"name_en" : "Ponte 16 Resort Macau",
									"seq" :"MM-0608020-10",
									"created_at" :"2014-06-09 23:27:35"
								},
								{ 	"id": "2",
									"name_cn": "蘭桂坊",
									"name_en": "Lan Kwai Fong",
									"seq":"MM-LM-10007-11",
									"created_at": "2014-06-09 23:27:35"
								},
								{ 	"id": "3",
									"name_cn": "凱旋門",
									"name_en": "L'Arc Macau",
									"seq": "MM-0606014-05",
									"created_at": "2014-06-09 23:27:35"
								},
								{ 	"id": "4",
									"name_cn": "新葡京",
									"name_en": "Grand Lisboa",
									"seq":"MM-0406012-04",
									"created_at":"2014-06-09 23:27:35"
								},
								{ 	"id": "5",
									"name_cn": "金沙",
									"name_en": "Sands Macau",
									"seq":"MM-0603005-02",
									"created_at":"2014-06-09 23:27:35"
								},
								{ 	"id": "6",
									"name_cn": "星際",
									"name_en": "Star World",
									"seq":"MM_LM-100903-12",
									"created_at":"2014-06-09 23:27:35"
								},
								{ 	"id": "7",
									"name_cn": "四季",
									"name_en": "Four Season Hotel",
									"seq":"MM_LM-100903-12",
									"created_at":"2014-06-09 23:27:35"
								},
								{ 	"id": "8",
									"name_cn": "威尼斯人一期",
									"name_en": "Venetian Cotai",
									"seq": "MM-0505001-15",
									"created_at": "2014-06-09 23:27:35"
								},
								{ 	"id": "9",
									"name_cn": "威尼斯人5,6期",
									"name_en": "Sands Cotai",
									"seq": "MM-0601006-17",
									"created_at": "2014-06-09 23:27:35"
								}
								];
							
						var cycles=[{ 	"value": "1",
									"name_cn": "月檢",
									"name_en": "Monthly"
								
								},{ 	"value": "2",
									"name_cn": "雙月檢",
									"name_en": "Even Monthly"
								
								},{ 	"value": "6",
									"name_cn": "半年檢",
									"name_en": "Semi-Annually"
								
								},{ 	"value": "12",
									"name_cn": "年檢",
									"name_en": "Annually"
								
								}];
// Cordova is loaded and it is now safe to make calls Cordova methods
function onDeviceReady() {
    navigator.splashscreen.hide();
	newCanvas();
	
	// accelerometer triggers
    startWatch();
}
	
var ctx, color = "#000", x = 0, y = 0, z = 0, etch = 0;	

$(document).ready(function () {
	// hide the accelerometer aka etch on/off button

	$("#etch").hide();
	var reportStr=	window.localStorage.getItem("report");
	var report=JSON.parse(reportStr);
	 showReportSummary(report);
	$("#canvasImg").attr("src",report.signature);
	// Call onDeviceReady when Cordova is loaded and talking with the native device
	document.addEventListener("deviceready", onDeviceReady, false);
		$("#save").click(function(){
	      report.signature=$("#canvasImg").attr("src");
	      window.localStorage.setItem("report", JSON.stringify(report));
	});
	// setup a new canvas for drawing
	
	
	// prevent footer to toggle on touch


	// reset palette selection (css) and select the clicked color for canvas strokeStyle
	// $(".palette").click(function(){
	// 	$(".palette").css("border-color", "#777");
	// 	$(".palette").css("border-style", "solid");
	// 	$(this).css("border-color", "#fff");
	// 	$(this).css("border-style", "dashed");
	// 	color = $(this).css("background-color");
		
	// });
	// link the new button with newCanvas() function
	$("#sign_pop_btn").click(function() {

		newCanvas();

	});
    
    // hide help popup when clicked anywhere on screen
    $("body").click(function(){
        $("#etchHelp").fadeOut();    
    });

	$("#etch").click(function(){
		if(etch) {
			etch = 0;
			$("#etch .ui-btn-text").text("Etch OFF");
			stopWatch();
		} else {
			etch = 1;
			$("#etch .ui-btn-text").text("Etch ON");
			startWatch();
		}
	});
	
	newCanvas();

	ctx.beginPath();
		ctx.strokeStyle = color;
	$("#save_sign").click(function(){
			var dataURL = document.getElementById("canvas").toDataURL();
	      $("#canvasImg").attr("src",dataURL);
	});
});


function showReportSummary(report){
	var cycle=jQuery.grep(cycles, function(element, index){
							
						  return element.value==report.cycle_type;

						});
	
	var customer=jQuery.grep(customers, function(element, index){
						  return element.id==report.customer_id;
						});

	$("#summary").append('<h3>'+customer[0].name_en+' '+ cycle[0].name_en+' Maintance Report</h3>');
	$("#summary").append('<p>Customer:  '+customer[0].name_en+'</p>');
    $("#summary").append('<p>Type:  '+cycle[0].name_en+'</p>');  
    $("#summary").append('<p>Date:  14/9/2014</p>');   
 	$("#summary").append('<p>Total Deivce:  '+report.froms.length+'</p>');  
 	  
    var content = '<table data-role="table" id="from_table" data-mode="reflow" class="ui-responsive table-stroke"><thead>\
			     <tr>\
			       <th data-priority="1">Device ID</th>\
			       <th data-priority="persist">Device Model</th>\
			       <th data-priority="2">Device Type</th>\
			       <th data-priority="3">Device Remark</th>\
			     </tr></thead><tbody>';
	for(i=0; i<report.froms.length; i++){
	    content += '<tr><td>' + report.froms[i].device_id +'</td><td>'+ report.froms[i].device_model+'</td><td>'+ report.froms[i].from_type+'</td><td>'+ report.froms[i].remark +'</td></tr>';
	}
	content += "</tbody></table>";

  	$("#summary").append(content);
  	$("#from_table").table();

}
// function to setup a new canvas for drawing
function newCanvas(){
	//define and resize canvas
    $("#content").height($(window).height()-180);
    var canvas = '<canvas id="canvas" width="'+$(window).width()+'" height="'+($(window).height()-180)+'"></canvas>';
	$("#content").html(canvas);
    
    // setup canvas
	ctx=document.getElementById("canvas").getContext("2d");
	ctx.strokeStyle = color;
	ctx.lineWidth = 5;	
    
    // set starting point in center
    ctx.beginPath();
	x = $(window).width()/2 ;
	y = ($(window).height()-180)/2 ;
	ctx.moveTo(x, y);
	
	// setup to trigger drawing on mouse or touch
	$("#canvas").drawTouch();
    $("#canvas").drawPointer();
	$("#canvas").drawMouse();	
}
        
// prototype to	start drawing on touch using canvas moveTo and lineTo
$.fn.drawTouch = function() {
	var start = function(e) {
        e = e.originalEvent;
		ctx.beginPath();
		x = e.changedTouches[0].pageX;
		y = e.changedTouches[0].pageY-44;
		ctx.moveTo(x,y);
	};
	var move = function(e) {
		e.preventDefault();
        e = e.originalEvent;
		x = e.changedTouches[0].pageX;
		y = e.changedTouches[0].pageY-44;
		ctx.lineTo(x,y);
		ctx.stroke();
	};
	$(this).on("touchstart", start);
	$(this).on("touchmove", move);	
}; 
    
// prototype to	start drawing on pointer(microsoft ie) using canvas moveTo and lineTo
$.fn.drawPointer = function() {
	var start = function(e) {
        e = e.originalEvent;
		ctx.beginPath();
		x = e.pageX;
		y = e.pageY-44;
		ctx.moveTo(x,y);
	};
	var move = function(e) {
		e.preventDefault();
        e = e.originalEvent;
		x = e.pageX;
		y = e.pageY-44;
		ctx.lineTo(x,y);
		ctx.stroke();
    };
	$(this).on("MSPointerDown", start);
	$(this).on("MSPointerMove", move);
};       

// prototype to	start drawing on mouse using canvas moveTo and lineTo
$.fn.drawMouse = function() {
	var clicked = 0;
	var start = function(e) {
		clicked = 1;
		ctx.beginPath();
		x = e.pageX;
		y = e.pageY-44;
		ctx.moveTo(x,y);
	};
	var move = function(e) {
		if(clicked){
			x = e.pageX;
			y = e.pageY-44;
			ctx.lineTo(x,y);
			ctx.stroke();
		}
	};
	var stop = function(e) {
		clicked = 0;
	};
	$(this).on("mousedown", start);
	$(this).on("mousemove", move);
	$(window).on("mouseup", stop);
};

// Start checking the accelerometer
function startWatch() {
    // Update acceleration every 1 seconds
    var options = { frequency: 100 };
    watchID = navigator.accelerometer.watchAcceleration(onSuccess, onError, options);
}

// Stop checking the accelerometer
function stopWatch() {
    if (watchID) {
        navigator.accelerometer.clearWatch(watchID);
        watchID = null;
    }
}

// onSuccess: draw line based on tilt and amount of tilt
function onSuccess(acceleration) {
    // for debug purpose to print out accelerometer values
	var element = document.getElementById('debug');
    element.innerHTML = 'Acceleration X: ' + acceleration.x + '<br />' +
                        'Acceleration Y: ' + acceleration.y + '<br />' +
                        'Acceleration Z: ' + acceleration.z ;
	
	// hide the accelerometer aka etch on/off button
	$("#etch").show();
    
    if (!etch) {
        $("#etchHelp").fadeIn(); 
        stopWatch();
        return;
    }
	
	// draw based on accelerometer positions
	if(acceleration.x > 2 && Math.abs(acceleration.y) < 2 ){
		if (x < 3){	
			buzzDevice(1);
			x = 3; 
		}
		x = x-Math.abs(acceleration.x);
		ctx.lineTo(x, y);
		ctx.stroke();
	} else if(acceleration.x < -2 && Math.abs(acceleration.y) < 2){
		if (x > $(window).width() - 3){
			buzzDevice(2);
			x = $(window).width() - 3;
		}
		x = x+Math.abs(acceleration.x);
		ctx.lineTo(x, y);
		ctx.stroke();
	} else if(acceleration.y > 2 && Math.abs(acceleration.x) < 2){
		if (y > $(window).height() - 93) { 
			buzzDevice(3);
			y = $(window).height() - 93;
		}
		y = y+Math.abs(acceleration.y);
		ctx.lineTo(x, y);
		ctx.stroke();
	} else if(acceleration.y < -2 && Math.abs(acceleration.x) < 2){
		if(y < 3) { 
			buzzDevice(4);
			y = 3;
		}
		y = y-Math.abs(acceleration.y);
		ctx.lineTo(x, y);
		ctx.stroke();
	}	
}

// onError: Failed to get the acceleration
function onError() {
    document.getElementById('debug').innerHTML = 'ERROR';
}

var position = 0;

// vibrate and beep when edge of screen it hit while accelerometer drawing
function buzzDevice(pos){
    if(position !== pos){ // vibrate only once when boudary is reached at a position
	    navigator.notification.vibrate(300);
        position = pos;
    }
}


	</script>
</head>
<body>
<div data-role="page" id="page1">
    <div data-theme="a" data-role="header">
        <h3>Signature</h3>
		<a id="back" data-rel="back" data-role="button" data-theme="b" class="ui-btn-left">Back</a>
		
		<a id="etch" data-role="button" data-theme="b" class="ui-btn-right">Etch OFF</a>
		<a id="save" data-role="button" data-theme="b" class="ui-btn-right">Save</a>
    </div>
     <div id="summary" class="ui-body ui-body-a ui-corner-all">

 
  </div>


  <div data-role="popup" id="popupSignature" data-overlay-theme="b" data-theme="b" data-dismissible="false" >

			    <div role="main" class="ui-content">
			      <div id="content"></div>
			      
			    </div>

			     <!-- <div data-role="footer" data-theme="c" data-position="fixed"> -->
						  <div class="center-wrapper">
  
			        <a id="save_sign" href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow">Save</a>
			        <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancel</a>
			        <!-- </div> -->
				</div>
			</div>
<div data-role="footer" data-theme="c" data-position="fixed">
  
	
	 <a id="sign_pop_btn" href="#popupSignature" data-rel="popup" data-position-to="window" data-transition="pop" data-role="button" data-theme="b" class="ui-btn-right">Sign</a>
	   <img  id="canvasImg"   width="200" height="50" >
   
	<!--   -->
		
</div>
    
    
     
	<div id="debug" style="display:none;position:absolute;top:45px;left:1px;right:1px;height:60px;background-color:#eea"></div>
    <div id="etchHelp">Turning <strong>Etch ON</strong> will enable drawing using the device's accelerometer by tilting the device in any direction.</div>
</div> 
</body>
</html>
