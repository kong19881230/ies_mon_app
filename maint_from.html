<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Regular Maintainance Report</title>
	<link rel="stylesheet" href="css/fb-style.min.css" />
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.4.3.min.css">
  	<link rel="stylesheet" href="css/jquery.mobile.icons-1.4.3.min.css">

	<link rel="stylesheet" href="css/listview-grid.css">

	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.4.3.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	<style>
	
	.mycontrolgroup .ui-controlgroup-controls
	{
		width: 100% !important;
	}
	.controlgroup-textinput
	{
		width: 44.5% !important;
	}
	.ui-field-contain>label{
			float: left;
			width: 55%;
			margin: .5em 2% 2% 2%;
	}
	.ui-field-contain>label~[class*=ui-], .ui-field-contain .right-container 
	{
		float: left;
		width: 40%;
		-webkit-box-sizing: border-box;
		-moz-box-sizing: border-box;
		box-sizing: border-box;
	}
	
	.current-page
	{
		background-color: #3388cc;
		border-color: #1c4a70;
		color: #ffffff;
		text-shadow: 0 1px 0 #005599;
	}

	.transparent_img {
    opacity: 0.4;
    filter: alpha(opacity=40); /* For IE8 and earlier */
	}
	</style>
	
	<script>
			
			var currentCameraID="";
			var currentRemarkCameraID="";
			$(document).ready(function(){

				var reportStr=	window.localStorage.getItem("report");
				var report=JSON.parse(reportStr);
				var  froms=JSON.parse(window.localStorage.getItem("currentForm")); 
				 var custom_tab_list=froms.catalogs;
				var from_default_name={};
				var remarks=[{
								"text":"",
								"photos":[]
				}]
				from_default_name["heat"]={"cn":"熱交換器表單","en":"Heat Transfer Compact Unit From"};
				from_default_name["boiler"]={"cn":"鍋爈表單","en":"Boiler From"};
				from_default_name["chimney"]={"cn":"鍋爈表單","en":"Chimney From"};
				
			
				$('#title').text(from_default_name[froms.from_type]["en"]);

				var items=froms.items;
				updateNavBar(custom_tab_list);
			
				for(var i in custom_tab_list){
					//$('#tab_navbar').append(createCustomTabTitle(custom_tab_list[i]));
					$('#tab_container').append(createCustomTab(custom_tab_list[i]));
					var tmp = jQuery.grep(items, function(element, index){
					  return element.group==custom_tab_list[i];
					});
					for(var j in tmp){ 
					  addFormItem(custom_tab_list[i]+"_items",tmp[j],parseInt(j)+1);
					}
				}
				//$('#tab_navbar_com').trigger('create');
				$('select').slider(); 
				$(".savebtn").click(function() {
					
					for(var index in items){ 
					  if(items[index].result.min_photos){
					  	var imgsrc =$('#photo_camera_'+items[index].index).attr("src");
					  	
					  	if(imgsrc!=items[index].result.exm_photos[0]){

					  		items[index].result.photos.push(imgsrc);
					  	}
					  }
					  if(items[index].result.type== "bool"){
							
							items[index].result.value=$("#filp_"+items[index].index).val();
							
					  }else if(items[index].result.type== "s_value"){
							items[index].result.value=$("#textinput_"+items[index].index).val();
						
					  }else if(items[index].result.type== "d_value"){
					  		items[index].result.value[0]=$("#textinput_0_"+items[index].index).val();
					  		items[index].result.value[1]=$("#textinput_1_"+items[index].index).val();
					  }
					
					}
					for(var i in remarks){
						remarks[i].text=$("#remark_text_"+i).val();
						for(var j in remarks[i].photos){
							var imgsrc =$('#remark_img_'+j+'_'+i).attr("src");
							remarks[i].photos[j]=imgsrc;
						}
					}
					froms.device_id=$('#deviceID').val();
					froms.device_model=$('#deviceModel').val();
					
					froms.name_en=from_default_name[froms.from_type]["en"]+" "+froms.device_id;
					froms.name_cn=from_default_name[froms.from_type]["cn"]+" "+froms.device_id;
					if($('#photo_camera_device').attr("src")!="eximages/device.png"){
						froms.device_photo=$('#photo_camera_device').attr("src");
					}
					
					froms.items=items;
					var editFromIndex=-1;
					for(var index in report.froms){ 
					  	if(report.froms[index].id==froms.id){
					  		editFromIndex=index;
					  	}
					}
					if(editFromIndex==-1){
						report.froms.push(froms);	
					}else{
						report.froms[editFromIndex]	=froms;
					}
					
					window.localStorage.setItem("report", JSON.stringify(report));
				});
				$(".tab-btn").click(function(event, ui){
						$(event.currentTarget.id).addClass("ui-btn-active");
						$('.custom_tab').hide();
						var tabname=event.currentTarget.id.split("_");
						$('#'+tabname).show();
				});
						$('.custom_tab').hide();
						$('#info').show();
				$("#add_remark_btn").click(function(event, ui){
					
					$("#remark_container").append(createRemark(remarks.length));
					$("#remark_container").trigger("create");

					remarks.push({text:"", photos:[]});
					$('.remark_camera').bind( "click", function(event, ui){
						currentRemarkCameraID=event.currentTarget.id;
						
						captureRemarkImage();
				});
				});	
				$(".input-textbox").change(function(event, ui) {
					var res = event.currentTarget.id.split("_");
							var index =res[res.length-1];
							var input_index=res[res.length-2];
							for(var i in items){ 
								if(items[i].index==index){
										
										if(items[i].result.type=="s_value"){
											items[i].result.value=event.currentTarget.value;
										}else if (items[i].result.type=="d_value"){
											items[i].result.value[input_index]=event.currentTarget.value;
												
										}	
										break;
								}
							}
							refreshAllCounter();
				});

				$('.remark_camera').bind( "click", function(event, ui){
						currentRemarkCameraID=event.currentTarget.id;
						captureRemarkImage();
				});
				$('.camera-btn').bind( "click", function(event, ui){
					
						currentCameraID=event.currentTarget.id;
						captureImage();
				});
				$('.ui-slider-switch').on('change', function(event, ui) {
				
							var res = event.currentTarget.id.split("_");
							var index =res[res.length-1];
							
							for(var i in items){ 
								if(items[i].index==index){
									items[i].result.value=event.currentTarget.value;
										break;
								}
							}
						refreshAllCounter();
				});
				function refreshAllCounter(){
					for(var i in custom_tab_list){
						$("."+custom_tab_list[i]+"_count").text(calCounter(items,custom_tab_list[i]));
					}
				}
				refreshAllCounter();
				if(froms.device_id!=""){
					$('#deviceID').val(froms.device_id);
				}
				if(froms.device_model!=""){
					$('#deviceModel').val(froms.device_model);
				}
				if(froms.device_photo!=""){
					 $('#photo_camera_device').attr("src", froms.device_photo);
					 $('#photo_camera_device').removeClass("transparent_img")
					 $('#popphoto_camera_device').attr("src", froms.device_photo);
				}else{
					$('#photo_camera_device').attr("src", froms.exm_photos);
					$('#popphoto_camera_device').attr("src", froms.exm_photos);
				}

				function onRemarkImageSuccess(imageURI) {
				
			
					var index=getIndex(currentRemarkCameraID);
							$("#photos_"+index).prepend('<li><a  href="#">\
	                <img id="remark_img_'+remarks[index].photos.length+'_'+index+'" src="'+imageURI+'" class="ui-li-thumb">\
	            </li>');
							remarks[index].photos.push(imageURI);
							alert(remarks[index].photos.length);
				}
			    function captureRemarkImage() {
			        // Launch device camera application,
			        // allowing user to capture up to 2 images
			 		 onRemarkImageSuccess(111);
			         navigator.camera.getPicture(onRemarkImageSuccess, onFail, { quality: 50,
					destinationType: Camera.DestinationType.FILE_URI });
			    }
			});
			function calCounter(items,group){
					var count=0;
				
					for(var index in items){ 
						if(items[index].group==group&&
						((items[index].result.type=="bool"&&items[index].result.value=="false")||
						(items[index].result.type=="s_value"&&items[index].result.value=="")||
						(items[index].result.type=="d_value"&&(items[index].result.value[0]=="" || items[index].result.value[1]=="")))){
							count++;
						}
					}
					return count;
			}
			function getIndex(id){
					var res =id.split("_");
					var index =res[res.length-1];
					return index;
				}
			function addFormItem(parent,item,i){
		//	 
			
				
				if(item.result.type == "bool"){
					$("#"+parent).append('<div id="item_'+item.index+'" class="ui-field-contain ui-shadow "> \
							<label for="textinput-1">'+i+'. '+item.item_name_en +'</label> \
								 <select name="flip-1" id="filp_'+item.index+'" data-role="slider" data-theme="c" class="ui-slider-switch"> \
									<option value="false">Not Check</option> \
									<option '+(item.result.value=="true"?'selected=""':'') + ' value="true">Check</option>	\
								</select>'+'</div>');
					
				}else if(item.result.type == "s_value"){
			
				
					$("#"+parent).append('<div id="item_'+item.index+'" class="ui-field-contain ui-shadow "> \
				<label for="textinput-1">'+i+'. '+item.item_name_en +'</label> \
					<input class="input-textbox"  type="text" name="textinput-5" id="textinput_'+item.index+'" placeholder="'+(item.result.unit?item.result.unit:'')+'" value="'+item.result.value+'" data-mini="true"/>' 
					+'</div>');
				
					$('#textinput_'+item.index).textinput();

				}else if(item.result.type == "d_value"){
			
				
					$("#"+parent).append('<div id="item_'+item.index+'" class="ui-field-contain ui-shadow  "> \
				<label for="textinput-1">'+i+'. '+item.item_name_en +'</label> \
					<div class="mycontrolgroup" id="controlgroup_'+item.index+'" data-role="controlgroup" data-type="horizontal" >\
					<input class="input-textbox" data-wrapper-class="controlgroup-textinput ui-btn"  type="text" name="textinput-5" id="textinput_0_'+item.index+'" placeholder="'+(item.result.unit?item.result.unit[0]:'')+'" value="'+item.result.value[0]+'" data-mini="true"/>\
					<input class="input-textbox" data-wrapper-class="controlgroup-textinput ui-btn"   type="text" name="textinput-5" id="textinput_1_'+item.index+'" placeholder="'+(item.result.unit?item.result.unit[1]:'')+'" value="'+item.result.value[1]+'" data-mini="true"/>' 
					+'</div></div>');

					$('#textinput_0_'+item.index).textinput();
					$('#textinput_1_'+item.index).textinput();	
					$('#controlgroup_'+item.index).controlgroup();
				}else if(item.result.type == "none"){
			
				
					$("#"+parent).append('<div id="item_'+item.index+'" class="ui-field-contain ui-shadow  "> \
				<label for="textinput-1">'+i+'. '+item.item_name_en +'</label> \
					</div>');

				}

				if(item.result.min_photos){

					$('#item_'+item.index).append('<div style="float: right; width: 40%;margin-right:1.5%;"  class="right-container">  <button id="camera_'+item.index+'" style="margin:5px" id="submit-1" data-mini="true"    class="camera-btn ui-btn ui-icon-camera ui-btn-icon-left ui-shadow ui-corner-all">Camera</button>\
					<div  style="float: right;" ><a href="#popupParis'+item.index+'" data-rel="popup" data-position-to="window" data-transition="fade"><img id="photo_camera_'+item.index+'" alt="Smiley face" '+(item.result.photos.length==0?'class="transparent_img"':'') +' src="'+(item.result.photos.length>0?item.result.photos[0]:item.result.exm_photos[0])+'" width="100" height="70" style="margin:5px"/></a></div>\
					 </div><div data-role="popup" id="popupParis'+item.index+'" data-overlay-theme="b" data-theme="b" data-corners="false">\
					    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a><img src="'+(item.result.photos.length>0?item.result.photos[0]:item.result.exm_photos[0])+'" id="popphoto_camera_'+item.index+'" class="popphoto"  style="max-height:250px;" alt="Paris, France"></div>');

					$('#popupParis'+item.index).trigger("create");
					$('#popupParis'+item.index).popup();
				}
				
			}
			function updateNavBar(custom_tab_list){
				$('#tab_navbar').remove();
				var navbar='<div id="tab_navbar" data-role="navbar" data-grid="'+String.fromCharCode(96 + custom_tab_list.length)+'" ><ul>';
				navbar+='<li><a  data-prefetch="true"  data-ajax="false" id="info_btn" class="tab-btn ui-btn-active">Info<span  class="info_count ui-li-count">2</span></a></li>';
				for(var i in custom_tab_list){
					navbar+=createCustomTabTitle(custom_tab_list[i]);
				}				
				navbar+='</ul></div>';
				$('#navbar_container').append(navbar).trigger('create');
			}

			function onSuccess(imageURI) {
				
				var image = document.getElementById('photo_'+currentCameraID);
				var image2 = document.getElementById('popphoto_'+currentCameraID);
				image.src = imageURI;
				image2.src = imageURI;
				$('#photo_'+currentCameraID).removeClass('transparent_img');
			}

			function onFail(message) {
				alert('Failed because: ' + message);
			}

		    // A button will call this function
		    //
		    function captureImage() {
		        // Launch device camera application,
		        // allowing user to capture up to 2 images
		       
		        
		         navigator.camera.getPicture(onSuccess, onFail, { quality: 50,
				destinationType: Camera.DestinationType.FILE_URI });
		    }
		    
		    function createCustomTab(name){
		    	return '<div id="'+name+'"  data-role="tabs" class="custom_tab" >\
								<div id="'+name+'_items">\
								</div>\
						</div>';
		    }
		     function createCustomTabTitle(name){
		    	return '<li><a href="#" data-prefetch="true" id="'+name+'_btn"  data-ajax="false" class="tab-btn ui-link ui-btn">'+capitaliseFirstLetter(name)+'\
		    		<span class="'+name+'_count ui-li-count">2</span></a></li>';
		    }			
	       function onScanBarcode(){

				cordova.plugins.barcodeScanner.scan(
				  function (result) {
					  alert("We got a barcode\n" +
							"Result: " + result.text + "\n" +
							"Format: " + result.format + "\n" +
							"Cancelled: " + result.cancelled);

					  $("#deviceID").val(result.text);
				  }, 
				  function (error) {
					  alert("Scanning failed: " + error);
				  }
			   );
		   }		
		   function createRemark(index){
		   	 return '<div class=" ui-shadow ui-content">\
				        <label for="textinput-hide" class="ui-hidden-accessible">Remark</label>\
						<input id="remark_text_'+index+'" type="text" name="textinput-hide" id="textinput-hide" placeholder="Text input" value="">\
				        <ul id="photos_'+index+'" data-role="listview" data-inset="true">\
				             <li><a id="camera_remark_'+index+'" href="#" class="remark_camera">\
				                <img src="images/camera-icon.jpg" class="ui-li-thumb">\
				            </a></li>\
				        </ul>\
				        </div>\
				    </div>';
		   }
		   function capitaliseFirstLetter(string)
			{
			    return string.charAt(0).toUpperCase() + string.slice(1);
			}	
	</script>
</head>
<body>
	
		<div id="chimney_from"  data-role="page" >
			 <div data-role="header" data-position="fixed"  >
			 <a href="maint_report.html" rel="external"  class="ui-btn  ui-btn-left ui-alt-icon ui-nodisc-icon ui-corner-all ui-btn-icon-left ui-icon-carat-l">Back</a>
	      
			  <h1 id="title">Chimney System From</h1>
			   <div data-role="controlgroup" data-type="horizontal" class="ui-mini ui-btn-right">
			  <a href="#remark" data-ajax="false" data-transition="pop" class="ui-btn ui-btn-b ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right ui-icon-check">Remark</a>
			  		<a href="#popupSaveSuccessInfo" data-rel="popup" data-position-to="window" data-transition="pop" class="savebtn ui-btn ui-btn-b ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right ui-icon-check">Save</a>
	    	</div>
	    	<div id="navbar_container">
	    		<div id="tab_navbar" data-role="navbar" data-grid="c" >
				<ul>
				<li><a  data-prefetch="true"  data-ajax="false" id="info_btn" class="tab-btn ui-btn-active">Info<span  class="info_count ui-li-count">2</span></a></li>
					
				
				</ul>
			</div>
	    	</div>
			
			</div><!-- /header -->
	
		
		  	 <div data-role="popup" data-theme="b" id="popupSaveSuccessInfo"  class="ui-content" style="max-width:280px">
				    <a  href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
					<p>Save successfully!!</p>
				</div>
			<div id="tab_container">
		<div id="info" data-role="tabs" class="custom_tab">
			<div class="ui-field-contain ui-shadow ">
				<label for="textinput-1">Device ID</label>
					<div style="float: left; width: 40%"  class="right-container">
					 <button style="margin:5px" id="submit-1" data-mini="true" onClick="onScanBarcode()" class=" ui-btn ui-icon-search ui-btn-icon-left ui-shadow ui-corner-all">Scan QRcode</button>
					
					
					<input   class="input-textbox"  type="text" name="textinput-5" id="deviceID"   />
						
					
					</div>
			</div>
			<div class="ui-field-contain ui-shadow ">
				<label for="textinput-1">Device Model</label>
					<div style="float: left; width: 40%"  class="right-container">
				
					
					<input   class="input-textbox"  type="text" name="textinput-5" id="deviceModel"   />
						
					
					</div>
			</div>
			<div class="ui-field-contain ui-shadow ui-corner-all">
				<label for="textinput-1">Device Photo</label>
				<div style="float: left; width: 40%"  class="right-container">
				 <button id="camera_device" style="margin:5px" id="submit-1" data-mini="true"    class="camera-btn ui-btn ui-icon-camera ui-btn-icon-left ui-shadow ui-corner-all">Camera</button>
				<div  style="float: right;" >
				 <a href="#popupParis" data-rel="popup" data-position-to="window" data-transition="fade"><img id="photo_camera_device" alt="Smiley face" class="transparent_img" src="eximages/device.png" width="100" height="70" style="margin:5px"/></a>
				 </div>
				 
				 </div>
				<div data-role="popup" id="popupParis" data-overlay-theme="b" data-theme="b" data-corners="false">
				    <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a><img src="eximages/device.png" id="popphoto_camera_device" class="popphoto"  style="max-height:250px;" alt="Paris, France">
				</div>
			</div>
		</div>
	
</div>
</div>
<div data-role="page" data-theme="a" id="remark" class="my-page">
	<div data-role="header" data-position="fixed" data-theme="b" >
			 <a href="#" data-rel="back"  class="ui-btn  ui-btn-left ui-alt-icon ui-nodisc-icon ui-corner-all ui-btn-icon-left ui-icon-carat-l">Back</a>
	      
			  <h1 id="title">Remarks</h1>
			
			  		<a id="save_remark" href="#popupSaveRemarkSuccessInfo" data-rel="popup" data-position-to="window" data-transition="pop" class="savebtn ui-btn-right ui-btn ui-btn-b ui-btn-inline ui-mini ui-corner-all ui-btn-icon-right ui-icon-check">Save</a>
	    	</div>
	    	 <div data-role="popup" data-theme="b" id="popupSaveRemarkSuccessInfo"  class="ui-content" style="max-width:280px">
				    <a  href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
					<p>Save successfully!!</p>
				</div>
    <div id="remark_container" role="main"   >
    <div class=" ui-shadow ui-content">
        <label for="textinput-hide" class="ui-hidden-accessible">Text Input:</label>
		<input id="remark_text_0" type="text" name="textinput-hide" id="textinput-hide" placeholder="Text input" value="">
        <ul id="photos_0" data-role="listview" data-inset="true">
           
          
             <li><a id="camera_remark_0" href="#" class="remark_camera">
                <img src="images/camera-icon.jpg" class="ui-li-thumb">
              
            </a></li>
        </ul>
        </div>
    </div><!-- /content -->
<div data-role="footer" data-theme="b" data-position="fixed">
			
				<div class="ui-bar">
				</div>
				<div data-role="controlgroup" data-type="horizontal" class="ui-mini ui-btn-left">
					<a id="add_remark_btn" href="#" rel="external" class="ui-btn ui-btn-icon-right ui-icon-plus">Add</a>
				
				</div>	
					
			   <h1></h1>
			
	    
		</div>
   
</div>
		<!-- /footer -->
		
		<script src="js/zepto.js"></script>
<!-- include carousel.js -->
<script src="js/carousel.js"></script>
<!-- construct the carousel -->
<script>$('.m-carousel').carousel()</script>
</body>
</html>
